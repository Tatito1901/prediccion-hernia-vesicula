sequenceDiagram
    participant U as ğŸ‘¤ Usuario<br/>Personal AdmisiÃ³n
    participant F as ğŸ–¥ï¸ Frontend<br/>NewPatientForm
    participant V as âœ… Validator<br/>Business Rules
    participant M as ğŸ›¡ï¸ Middleware<br/>Auth & Security
    participant A as ğŸš€ API<br/>patient-admission
    participant R as âš™ï¸ RPC Function<br/>create_patient_and_appointment
    participant DB as ğŸ—„ï¸ Database<br/>PostgreSQL
    participant RT as ğŸ“¡ Realtime<br/>Supabase
    participant C as ğŸ’¾ Cache<br/>React Query
    
    %% INICIO DEL FLUJO
    U->>F: 1. Llenar formulario paciente
    Note over F: ValidaciÃ³n en tiempo real<br/>con Zod schema
    
    U->>F: 2. Seleccionar fecha/hora
    F->>F: 3. Verificar slots disponibles
    Note over F: Generar horarios<br/>8:00-18:00 (no almuerzo)
    
    U->>F: 4. Enviar formulario
    F->>V: 5. Validar business rules
    
    %% VALIDACIONES
    V->>V: 6. Validar horario laboral
    V->>V: 7. Validar no fin de semana
    V->>V: 8. Validar no muy futuro (90 dÃ­as)
    alt âŒ ValidaciÃ³n falla
        V-->>F: Error de validaciÃ³n
        F-->>U: Mostrar error + sugerencias
    end
    
    %% PROCESO EXITOSO
    V->>A: 9. âœ… Datos vÃ¡lidos
    F->>M: 10. POST /api/patient-admission
    
    %% MIDDLEWARE SECURITY
    M->>M: 11. Verificar auth token
    M->>M: 12. Validar permisos usuario
    M->>M: 13. Obtener user ID
    alt âŒ Auth falla
        M-->>F: 401 Unauthorized
        F-->>U: Redirigir a login
    end
    
    %% API PROCESSING
    M->>A: 14. âœ… Request autorizado
    A->>A: 15. Validar payload con Zod
    A->>A: 16. Verificar conflictos horario
    A->>DB: 17. Query conflictos existentes
    DB-->>A: 18. Resultado consulta
    
    alt âŒ Conflicto encontrado
        A-->>F: 409 Conflict + horarios sugeridos
        F-->>U: Mostrar conflicto + alternativas
    end
    
    %% DATABASE TRANSACTION
    A->>R: 19. âœ… Sin conflictos
    Note over R: FunciÃ³n RPC transaccional
    
    R->>DB: 20. BEGIN TRANSACTION
    R->>DB: 21. Validar no paciente duplicado
    R->>DB: 22. INSERT INTO patients
    R->>DB: 23. INSERT INTO appointments
    R->>DB: 24. INSERT INTO appointment_history
    R->>DB: 25. COMMIT TRANSACTION
    
    alt âŒ Error en transacciÃ³n
        R->>DB: ROLLBACK
        R-->>A: Error detallado
        A-->>F: 500 Internal Error
        F-->>U: Error + reintento
    end
    
    %% SUCCESS FLOW
    DB-->>R: 26. âœ… IDs creados
    R-->>A: 27. Success + patient_id
    A->>A: 28. Fetch datos completos
    A-->>F: 29. 201 Created + datos
    
    %% REAL-TIME UPDATES
    DB->>RT: 30. ğŸ“¡ Database change event
    RT->>C: 31. Invalidate cache keys
    RT->>F: 32. WebSocket update
    
    %% UI UPDATES
    F->>C: 33. Update React Query cache
    F->>F: 34. Reset formulario
    F->>F: 35. Switch to "Hoy" tab
    F-->>U: 36. âœ… Success notification
    
    %% NOTIFICACIONES
    Note over U,C: ğŸ‰ Paciente creado exitosamente<br/>ğŸ“‹ Visible en lista de citas<br/>ğŸ“¡ Otras sesiones actualizadas
    
    %% ESTILOS
    Note right of F: â€¢ Form validation<br/>â€¢ Error handling<br/>â€¢ Loading states
    Note right of V: â€¢ Horario laboral<br/>â€¢ Conflictos<br/>â€¢ Business rules
    Note right of M: â€¢ JWT validation<br/>â€¢ Role checking<br/>â€¢ Rate limiting
    Note right of A: â€¢ Input validation<br/>â€¢ Conflict detection<br/>â€¢ Error responses
    Note right of R: â€¢ ACID transaction<br/>â€¢ Constraint validation<br/>â€¢ Rollback safety
    Note right of RT: â€¢ Real-time sync<br/>â€¢ Cache invalidation<br/>â€¢ Multi-user updates